name: Auto-Update Structure

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allows manual trigger

jobs:
  update-structure:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout main repo
        uses: actions/checkout@v3
        with:
          path: main-repo
          
      - name: Checkout structure repo
        uses: actions/checkout@v3
        with:
          repository: CMVault/cmv-structure
          token: ${{ secrets.GITHUB_TOKEN }}
          path: structure-repo
          
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Copy current PROJECT_STATUS.md to structure repo
        run: |
          if [ -f main-repo/PROJECT_STATUS.md ]; then
            cp main-repo/PROJECT_STATUS.md structure-repo/
          fi
          
      - name: Generate structure
        run: |
          cd main-repo
          echo "Current directory: $(pwd)"
          echo "Files before generation:"
          ls -la ../structure-repo
          
          # Run the generator
          node scripts/generate-structure.js ../structure-repo
          
          echo "Files after generation:"
          ls -la ../structure-repo
          
          # Show content of structure repo
          echo "Content of generated files:"
          ls -la ../structure-repo/
          
          # Check if files were actually created
          if [ -f ../structure-repo/STRUCTURE.json ]; then
            echo "✅ STRUCTURE.json was created successfully"
            echo "File size: $(wc -c < ../structure-repo/STRUCTURE.json) bytes"
          else
            echo "❌ STRUCTURE.json was NOT created"
          fi
          
      - name: Copy updated PROJECT_STATUS.md back to main repo
        run: |
          if [ -f structure-repo/PROJECT_STATUS.md ]; then
            cp structure-repo/PROJECT_STATUS.md main-repo/
            cd main-repo
            git config user.name "Structure Bot"
            git config user.email "bot@cmvault.com"
            git add PROJECT_STATUS.md
            git diff --staged --quiet || git commit -m "🤖 Auto-update PROJECT_STATUS.md"
            git push
          fi
          
      - name: Commit structure repo changes
        run: |
          cd structure-repo
          
          # List all files to debug
          echo "All files in structure repo:"
          ls -la
          
          # Configure git
          git config user.name "Structure Bot"
          git config user.email "bot@cmvault.com"
          
          # Add all files
          git add .
          
          # Check what will be committed
          echo "Files to be committed:"
          git status
          
          # Commit if there are changes
          if ! git diff --staged --quiet; then
            git commit -m "🤖 Auto-update structure and status"
            git push
            echo "✅ Changes pushed successfully"
          else
            echo "⚠️ No changes to commit"
          fi
