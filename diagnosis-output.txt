🔍 Deep Diagnosis of CMV System
================================

1️⃣ PM2 Process Details:
[1m[7m Describing process with id 3 - name cmv-discovery [27m[22m
┌───────────────────┬───────────────────────────────────────────────────────────┐
│ status            │ [31m[1merrored[22m[39m                                                   │
│ name              │ cmv-discovery                                             │
│ namespace         │ default                                                   │
│ version           │ 1.0.0                                                     │
│ restarts          │ 122                                                       │
│ uptime            │ 0                                                         │
│ script path       │ /Users/patrickalbani/Desktop/cmv/unified-camera-system.js │
│ script args       │ N/A                                                       │
│ error log path    │ /Users/patrickalbani/.pm2/logs/cmv-discovery-error.log    │
│ out log path      │ /Users/patrickalbani/.pm2/logs/cmv-discovery-out.log      │
│ pid path          │ /Users/patrickalbani/.pm2/pids/cmv-discovery-3.pid        │
│ interpreter       │ node                                                      │
│ interpreter args  │ N/A                                                       │
│ script id         │ 3                                                         │
│ exec cwd          │ /Users/patrickalbani/Desktop/cmv                          │
│ exec mode         │ fork_mode                                                 │
│ node.js version   │ 22.18.0                                                   │
│ node env          │ N/A                                                       │
│ watch & reload    │ ✘                                                         │
│ unstable restarts │ 0                                                         │
│ created at        │ N/A                                                       │
└───────────────────┴───────────────────────────────────────────────────────────┘
[7m[1m Divergent env variables from local env [22m[27m
┌───────┬──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│ COLOR │ 1                                                                                                                                                                                                                                                │
│ PATH  │ /Users/patrickalbani/Desktop/cmv/node_modules/.bin:/Users/patrickalbani/Desktop/cmv/node_modules/.bin:/Users/patrickalbani/Desktop/node_modules/.bin:/Users/patrickalbani/node_modules/.bin:/Users/node_modules/.bin:/node_modules/.bin:/usr/loc │
│ SHLVL │ 2                                                                                                                                                                                                                                                │
└───────┴──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘

[37m[3m Add your own code metrics: http://bit.ly/code-metrics[23m[39m
[37m[3m Use `pm2 logs cmv-discovery [--lines 1000]` to display logs[23m[39m
[37m[3m Use `pm2 env 3` to display environment variables[23m[39m
[37m[3m Use `pm2 monit` to monitor CPU and Memory usage[23m[39m cmv-discovery

2️⃣ All Node Processes:
patrickalbani     1865   0.5  0.5 1866875328  45920   ??  S     2:58PM   3:59.36 /Applications/Visual Studio Code.app/Contents/Frameworks/Code Helper.app/Contents/MacOS/Code Helper --type=utility --utility-sub-type=node.mojom.NodeService --lang=en-US --service-sandbox-type=none --user-data-dir=/Users/patrickalbani/Library/Application Support/Code --standard-schemes=vscode-webview,vscode-file --enable-sandbox --secure-schemes=vscode-webview,vscode-file --cors-schemes=vscode-webview,vscode-file --fetch-schemes=vscode-webview,vscode-file --service-worker-schemes=vscode-webview --code-cache-schemes=vscode-webview,vscode-file --shared-files --field-trial-handle=1718379636,r,13786732848211729696,582543410737946246,262144 --enable-features=DocumentPolicyIncludeJSCallStacksInCrashReports,EarlyEstablishGpuChannel,EstablishGpuChannelAsync,ScreenCaptureKitPickerScreen,ScreenCaptureKitStreamPickerSonoma --disable-features=CalculateNativeWinOcclusion,MacWebContentsOcclusion,SpareRendererForSitePerProcess,TimeoutHangingVideoCaptureStarts --variations-seed-version
patrickalbani    70718   0.0  0.2 411638224  14544 s063  S+    2:06PM   0:00.24 node /Users/patrickalbani/Desktop/cmv/node_modules/.bin/pm2 logs cmv-discovery --lines 50
patrickalbani    69702   0.0  0.2 411638224  13280 s061  S+    2:02PM   0:00.25 node /Users/patrickalbani/Desktop/cmv/node_modules/.bin/pm2 logs cmv-discovery --lines 50
patrickalbani    67975   0.0  0.2 411637968  13248 s055  S+    1:55PM   0:00.29 node /Users/patrickalbani/Desktop/cmv/node_modules/.bin/pm2 logs cmv-discovery --lines 50
patrickalbani    67633   0.0  0.2 411638224  13248 s054  S+    1:53PM   0:00.31 node /Users/patrickalbani/Desktop/cmv/node_modules/.bin/pm2 logs cmv-discovery --lines 50
patrickalbani    66775   0.0  0.2 411637968  13136 s051  S+    1:50PM   0:00.32 node /Users/patrickalbani/Desktop/cmv/node_modules/.bin/pm2 logs cmv-discovery --lines 50
patrickalbani    66423   0.0  0.2 411638224  13136 s049  S+    1:46PM   0:00.33 node /Users/patrickalbani/Desktop/cmv/node_modules/.bin/pm2 logs cmv-discovery --lines 50
patrickalbani    65514   0.0  0.2 411638736  13008 s047  S+    1:40PM   0:00.34 node /Users/patrickalbani/Desktop/cmv/node_modules/.bin/pm2 logs cmv-discovery --lines 50
patrickalbani    65210   0.0  0.2 411637968  13008 s043  S+    1:38PM   0:00.36 node /Users/patrickalbani/Desktop/cmv/node_modules/.bin/pm2 logs cmv-discovery --lines 50
patrickalbani    64078   0.0  0.2 411638224  13024 s041  S+    1:26PM   0:00.39 node /Users/patrickalbani/Desktop/cmv/node_modules/.bin/pm2 logs cmv-discovery --lines 50
patrickalbani    63102   0.0  0.2 411637968  13024 s003  S+    1:20PM   0:00.42 node /Users/patrickalbani/Desktop/cmv/node_modules/.bin/pm2 logs cmv-discovery --lines 50
patrickalbani    61550   0.0  0.2 411638224  13104 s038  S+    1:09PM   0:00.44 node /Users/patrickalbani/Desktop/cmv/node_modules/.bin/pm2 logs cmv-discovery
patrickalbani    60352   0.0  0.3 421724448  24368   ??  Ss   12:59PM   0:14.50 node /Users/patrickalbani/Desktop/cmv/server.js 
patrickalbani    46456   0.0  0.2 422255152  17312   ??  S     9:36AM   0:37.93 node /Users/patrickalbani/Desktop/cmv/server-minimal.js 
patrickalbani    46280   0.0  0.1 411638224  11088 s027  S+    9:34AM   0:00.43 node /Users/patrickalbani/Desktop/cmv/node_modules/.bin/pm2 logs cmv-server --lines 30
patrickalbani    43320   0.0  0.1 411637968  11168 s023  S+    8:46AM   0:00.40 node /Users/patrickalbani/Desktop/cmv/node_modules/.bin/pm2 logs cmv-automation --lines 20
patrickalbani    43166   0.0  0.1 411638224  11088 s021  S+    8:46AM   0:00.39 node /Users/patrickalbani/Desktop/cmv/node_modules/.bin/pm2 logs cmv-server --lines 20
patrickalbani    12290   0.0  0.2 1865064304  14688   ??  S     4:44PM   0:03.06 /Applications/Visual Studio Code.app/Contents/Frameworks/Code Helper (Plugin).app/Contents/MacOS/Code Helper (Plugin) /Applications/Visual Studio Code.app/Contents/Resources/app/extensions/html-language-features/server/dist/node/htmlServerMain --node-ipc --clientProcessId=1864
patrickalbani     9104   0.0  0.2 1865069424  14752   ??  S     4:13PM   0:00.89 /Applications/Visual Studio Code.app/Contents/Frameworks/Code Helper (Plugin).app/Contents/MacOS/Code Helper (Plugin) /Applications/Visual Studio Code.app/Contents/Resources/app/extensions/node_modules/typescript/lib/typingsInstaller.js --globalTypingsCacheLocation /Users/patrickalbani/Library/Caches/typescript/5.8 --enableTelemetry --typesMapLocation /Applications/Visual Studio Code.app/Contents/Resources/app/extensions/node_modules/typescript/lib/typesMap.json --validateDefaultNpmLocation
patrickalbani     9100   0.0  0.3 1865047920  24032   ??  S     4:13PM   0:19.81 /Applications/Visual Studio Code.app/Contents/Frameworks/Code Helper (Plugin).app/Contents/MacOS/Code Helper (Plugin) --max-old-space-size=3072 /Applications/Visual Studio Code.app/Contents/Resources/app/extensions/node_modules/typescript/lib/tsserver.js --useInferredProjectPerProjectRoot --enableTelemetry --cancellationPipeName /var/folders/jp/f68fyyjd75s8qgc_w9m5tpl40000gn/T/vscode-typescript501/108f6b03d8bfe0f6745c/tscancellation-8f5199d613ae79ef82c5.tmp* --locale en --noGetErrOnBackgroundUpdate --canUseWatchEvents --validateDefaultNpmLocation --useNodeIpc
patrickalbani     9099   0.0  0.2 1865055088  19616   ??  S     4:13PM   0:03.15 /Applications/Visual Studio Code.app/Contents/Frameworks/Code Helper (Plugin).app/Contents/MacOS/Code Helper (Plugin) --max-old-space-size=3072 /Applications/Visual Studio Code.app/Contents/Resources/app/extensions/node_modules/typescript/lib/tsserver.js --serverMode partialSemantic --useInferredProjectPerProjectRoot --disableAutomaticTypingAcquisition --cancellationPipeName /var/folders/jp/f68fyyjd75s8qgc_w9m5tpl40000gn/T/vscode-typescript501/108f6b03d8bfe0f6745c/tscancellation-a4da48bdbe61ebf3b307.tmp* --locale en --noGetErrOnBackgroundUpdate --canUseWatchEvents --validateDefaultNpmLocation --useNodeIpc
patrickalbani     2268   0.0  0.2 1865057136  18496   ??  S     3:02PM   0:03.46 /Applications/Visual Studio Code.app/Contents/Frameworks/Code Helper (Plugin).app/Contents/MacOS/Code Helper (Plugin) /Applications/Visual Studio Code.app/Contents/Resources/app/extensions/markdown-language-features/dist/serverWorkerMain --node-ipc --clientProcessId=1864
patrickalbani     1961   0.0  0.2 1865080880  16640   ??  S     2:58PM   0:02.83 /Applications/Visual Studio Code.app/Contents/Frameworks/Code Helper (Plugin).app/Contents/MacOS/Code Helper (Plugin) /Applications/Visual Studio Code.app/Contents/Resources/app/extensions/json-language-features/server/dist/node/jsonServerMain --node-ipc --clientProcessId=1864
patrickalbani     1864   0.0  0.7 1866856160  58432   ??  S     2:58PM   0:55.09 /Applications/Visual Studio Code.app/Contents/Frameworks/Code Helper (Plugin).app/Contents/MacOS/Code Helper (Plugin) --type=utility --utility-sub-type=node.mojom.NodeService --lang=en-US --service-sandbox-type=none --dns-result-order=ipv4first --experimental-network-inspection --inspect-port=0 --user-data-dir=/Users/patrickalbani/Library/Application Support/Code --standard-schemes=vscode-webview,vscode-file --enable-sandbox --secure-schemes=vscode-webview,vscode-file --cors-schemes=vscode-webview,vscode-file --fetch-schemes=vscode-webview,vscode-file --service-worker-schemes=vscode-webview --code-cache-schemes=vscode-webview,vscode-file --shared-files --field-trial-handle=1718379636,r,13786732848211729696,582543410737946246,262144 --enable-features=DocumentPolicyIncludeJSCallStacksInCrashReports,EarlyEstablishGpuChannel,EstablishGpuChannelAsync,ScreenCaptureKitPickerScreen,ScreenCaptureKitStreamPickerSonoma --disable-features=CalculateNativeWinOcclusion,MacWebContentsOcclusion,SpareRendererForSitePerProcess,TimeoutHangingVideoCaptureStarts --variations-seed-version
patrickalbani     1863   0.0  0.4 1866837312  33120   ??  S     2:58PM   0:19.34 /Applications/Visual Studio Code.app/Contents/Frameworks/Code Helper.app/Contents/MacOS/Code Helper --type=utility --utility-sub-type=node.mojom.NodeService --lang=en-US --service-sandbox-type=none --user-data-dir=/Users/patrickalbani/Library/Application Support/Code --standard-schemes=vscode-webview,vscode-file --enable-sandbox --secure-schemes=vscode-webview,vscode-file --cors-schemes=vscode-webview,vscode-file --fetch-schemes=vscode-webview,vscode-file --service-worker-schemes=vscode-webview --code-cache-schemes=vscode-webview,vscode-file --shared-files --field-trial-handle=1718379636,r,13786732848211729696,582543410737946246,262144 --enable-features=DocumentPolicyIncludeJSCallStacksInCrashReports,EarlyEstablishGpuChannel,EstablishGpuChannelAsync,ScreenCaptureKitPickerScreen,ScreenCaptureKitStreamPickerSonoma --disable-features=CalculateNativeWinOcclusion,MacWebContentsOcclusion,SpareRendererForSitePerProcess,TimeoutHangingVideoCaptureStarts --variations-seed-version
patrickalbani     1862   0.0  0.4 1866826464  30384   ??  S     2:58PM   0:12.14 /Applications/Visual Studio Code.app/Contents/Frameworks/Code Helper.app/Contents/MacOS/Code Helper --type=utility --utility-sub-type=node.mojom.NodeService --lang=en-US --service-sandbox-type=none --user-data-dir=/Users/patrickalbani/Library/Application Support/Code --standard-schemes=vscode-webview,vscode-file --enable-sandbox --secure-schemes=vscode-webview,vscode-file --cors-schemes=vscode-webview,vscode-file --fetch-schemes=vscode-webview,vscode-file --service-worker-schemes=vscode-webview --code-cache-schemes=vscode-webview,vscode-file --shared-files --field-trial-handle=1718379636,r,13786732848211729696,582543410737946246,262144 --enable-features=DocumentPolicyIncludeJSCallStacksInCrashReports,EarlyEstablishGpuChannel,EstablishGpuChannelAsync,ScreenCaptureKitPickerScreen,ScreenCaptureKitStreamPickerSonoma --disable-features=CalculateNativeWinOcclusion,MacWebContentsOcclusion,SpareRendererForSitePerProcess,TimeoutHangingVideoCaptureStarts --variations-seed-version
patrickalbani    78480   0.0  0.4 410981584  35248 s069  S+    2:44PM   0:00.18 node /Users/patrickalbani/Desktop/cmv/node_modules/.bin/pm2 logs cmv-discovery --lines 50
patrickalbani    77342   0.0  0.4 411638736  35280 s067  S+    2:41PM   0:00.18 node /Users/patrickalbani/Desktop/cmv/node_modules/.bin/pm2 logs cmv-discovery --lines 30

3️⃣ File PM2 is running:
│ script path       │ /Users/patrickalbani/Desktop/cmv/unified-camera-system.js │

4️⃣ Syntax check on main file:
/Users/patrickalbani/Desktop/cmv/unified-camera-system.js:322
    function function scheduleDiscovery() {
             ^^^^^^^^

SyntaxError: Unexpected token 'function'
    at wrapSafe (node:internal/modules/cjs/loader:1620:18)
    at checkSyntax (node:internal/main/check_syntax:78:3)

Node.js v22.18.0

5️⃣ Other JavaScript files in directory:
-rw-r--r--@ 1 patrickalbani  staff   4768 Aug  4 14:35 automated-cmv-fix.js
-rw-r--r--@ 1 patrickalbani  staff   6765 Aug  3 16:45 automation-routes.js
-rw-r--r--@ 1 patrickalbani  staff    302 Aug  4 12:58 camera-utils.js
-rw-r--r--@ 1 patrickalbani  staff   3614 Aug  4 11:22 check-image-status.js
-rwxr-xr-x@ 1 patrickalbani  staff   2580 Aug  3 14:16 cleanup.js
-rw-r--r--@ 1 patrickalbani  staff   1288 Aug  3 17:31 debug-save.js
-rw-r--r--@ 1 patrickalbani  staff   8378 Aug  3 17:43 diagnose-db.js
-rw-r--r--@ 1 patrickalbani  staff   2586 Aug  4 08:21 disable-auto-automation.js
-rw-r--r--@ 1 patrickalbani  staff    902 Aug  4 08:36 ecosystem.config.js
-rw-r--r--@ 1 patrickalbani  staff  13187 Aug  4 13:52 final-unified-camera-system.js
-rw-r--r--@ 1 patrickalbani  staff   5802 Aug  3 17:18 fix-all-database.js
-rw-r--r--@ 1 patrickalbani  staff   3954 Aug  4 14:29 fix-all-missing-functions.js
-rw-r--r--@ 1 patrickalbani  staff    453 Aug  4 10:23 fix-api-response.js
-rw-r--r--@ 1 patrickalbani  staff   4293 Aug  3 17:36 fix-column-names.js
-rw-r--r--@ 1 patrickalbani  staff   2775 Aug  4 14:01 fix-db-columns.js
-rwxr-xr-x@ 1 patrickalbani  staff  14359 Aug  4 13:15 fix-everything-intelligently.js
-rw-r--r--@ 1 patrickalbani  staff   2689 Aug  4 14:05 fix-extra-braces.js
-rw-r--r--@ 1 patrickalbani  staff   1873 Aug  4 08:26 fix-server-now.js
-rw-r--r--@ 1 patrickalbani  staff   3271 Aug  4 13:25 fix-sql-query.js
-rw-r--r--@ 1 patrickalbani  staff   2665 Aug  4 13:37 fix-syntax-error.js
-rw-r--r--@ 1 patrickalbani  staff   1287 Aug  4 14:22 minimal-syntax-fix.js
-rw-r--r--@ 1 patrickalbani  staff   1050 Aug  4 12:17 monitor.js
-rw-r--r--@ 1 patrickalbani  staff    488 Aug  4 09:40 nano fix-api-response.js
-rw-r--r--@ 1 patrickalbani  staff   1464 Aug  3 14:28 quick-db-fix.js
-rw-r--r--@ 1 patrickalbani  staff   9753 Aug  4 08:35 server-minimal.js
-rw-r--r--@ 1 patrickalbani  staff  19967 Aug  4 08:26 server.js
-rw-r--r--@ 1 patrickalbani  staff   5163 Aug  4 13:45 smart-fix-unified-system.js
-rw-r--r--@ 1 patrickalbani  staff  21244 Aug  3 17:48 ultimate-schema-fix.js
-rw-r--r--@ 1 patrickalbani  staff     14 Aug  4 12:17 unified-camera-system-temp.js
-rw-r--r--@ 1 patrickalbani  staff  20804 Aug  4 13:50 unified-camera-system.broken.js
-rw-r--r--@ 1 patrickalbani  staff  13320 Aug  4 14:43 unified-camera-system.js
-rw-r--r--@ 1 patrickalbani  staff   6983 Aug  4 11:23 update-camera-images.js

6️⃣ PM2 Ecosystem config:
module.exports = {
  apps: [
    {
      name: 'cmv-server',
      script: './server-minimal.js',
      instances: 1,
      autorestart: true,
      watch: false,
      max_memory_restart: '1G',
      env: {
        NODE_ENV: 'production',
        PORT: 3000
      },
      error_file: './logs/server-error.log',
      out_file: './logs/server-out.log',
      log_file: './logs/server-combined.log',
      time: true
    },
    {
      name: 'cmv-automation',
      script: './automation-scheduler.js',
      instances: 1,
      autorestart: true,
      watch: false,
      max_memory_restart: '500M',
      env: {
        NODE_ENV: 'production'
      },
      error_file: './logs/automation-error.log',
      out_file: './logs/automation-out.log',
      log_file: './logs/automation-combined.log',
      time: true,
      cron_restart: '0 0 * * *' // Daily restart at midnight for cleanup
    }
  ]
};
7️⃣ Package.json scripts:
  "scripts": {
    "start": "node server.js",
    "dev": "nodemon server.js",
    "start:prod": "NODE_ENV=production node server.js",
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "keywords": [
    "camera",
    "manual",
    "database"
  ],

8️⃣ Line 322 content:
     1	        });
     2	
     3	    function function scheduleDiscovery() {
     4	        console.log('📅 Schedule set:');
     5	        console.log('   - Discovery: Every 4 hours (200/day limit)');
     6	        console.log('   - Backup: Daily at 3 AM');

9️⃣ Searching for duplicate 'scheduleDiscovery' definitions:
37:        this.scheduleDiscovery();
322:    function function scheduleDiscovery() {

🔟 File size and line count:
     382 unified-camera-system.js
-rw-r--r--@ 1 patrickalbani  staff    13K Aug  4 14:43 unified-camera-system.js

📋 Diagnosis complete!
